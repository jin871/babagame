<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒãƒæŠœãã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆç°¡æ˜“ç‰ˆï¼‰</title>
  <style>
    #myHand span {
      display: inline-block;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 8px 12px;
      margin: 2px;
      font-size: 20px;
      cursor: default;
      user-select: none;
    }

    #log {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>

<body>

  <h2>ãƒãƒæŠœãã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆç°¡æ˜“ç‰ˆï¼‰</h2>

  <p>
    ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å: <input id="playerName" type="text" placeholder="åå‰ã‚’å…¥åŠ›" />
  </p>
  <p>
    ãƒ«ãƒ¼ãƒ ID: <input id="roomId" type="text" placeholder="ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›" />
  </p>
  <p>
    <button onclick="createRoom()">ãƒ«ãƒ¼ãƒ ä½œæˆ</button>
    <button onclick="joinRoom()">ãƒ«ãƒ¼ãƒ å‚åŠ </button>
  </p>

  <p id="log">ãƒ­ã‚°ï¼šã“ã“ã«è¡¨ç¤º</p>

  <button id="drawCardBtn" disabled onclick="drawCard()">ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã</button>

  <h3>è‡ªåˆ†ã®æ‰‹æœ­</h3>
  <div id="myHand"></div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA0D7fOnIvQFU3O29q6bb_6gj5tWN23N0s",
      authDomain: "memory-game-10e98.firebaseapp.com",
      databaseURL: "https://memory-game-10e98-default-rtdb.firebaseio.com",
      projectId: "memory-game-10e98",
      storageBucket: "memory-game-10e98.appspot.com",
      messagingSenderId: "435852264433",
      appId: "1:435852264433:web:0ef957830b634b9eb13a50",
      measurementId: "G-8GN7P9PFX7"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let playerName = "";
    let roomId = "";
    let currentPlayers = [];
    let currentTurnIndex = null;

    function createDeck() {
      const suits = ["â™ ", "â™¥", "â™¦", "â™£"];
      const ranks = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];
      const deck = [];

      for (const suit of suits) {
        for (const rank of ranks) {
          deck.push(rank + suit);
        }
      }
      deck.push("JOKER");
      return deck;
    }

    function shuffleDeck(deck) {
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
      return deck;
    }

    async function createRoom() {
      playerName = document.getElementById("playerName").value.trim();
      roomId = document.getElementById("roomId").value.trim();
      if (!playerName || !roomId) {
        alert("åå‰ã¨ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      const roomRef = ref(database, 'rooms/' + roomId);
      const snapshot = await get(roomRef);
      if (snapshot.exists()) {
        alert("ãã®ãƒ«ãƒ¼ãƒ IDã¯æ—¢ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™");
        return;
      }

      await set(roomRef, {
        players: [playerName],
        turnIndex: 0,
        state: "waiting"
      });

      log(`ãƒ«ãƒ¼ãƒ ã€Œ${roomId}ã€ã‚’ä½œæˆã—ã¾ã—ãŸã€‚å‚åŠ å¾…ã¡...`);
      watchRoomPlayers(roomId);
      watchTurn(roomId);
      watchTurnControl(roomId);
      watchMyHand(roomId);

      await dealCards(roomId);
    }

    async function joinRoom() {
      playerName = document.getElementById("playerName").value.trim();
      roomId = document.getElementById("roomId").value.trim();
      if (!playerName || !roomId) {
        alert("åå‰ã¨ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      const roomRef = ref(database, 'rooms/' + roomId);
      const snapshot = await get(roomRef);
      if (!snapshot.exists()) {
        alert("ãƒ«ãƒ¼ãƒ ãŒå­˜åœ¨ã—ã¾ã›ã‚“");
        return;
      }
      const data = snapshot.val();
      const players = data.players || [];

      if (players.length >= 4) {
        alert("ã“ã®ãƒ«ãƒ¼ãƒ ã¯æº€å“¡ã§ã™");
        return;
      }

      if (players.includes(playerName)) {
        alert("ãã®åå‰ã¯ã™ã§ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™");
        return;
      }

      players.push(playerName);
      await update(roomRef, { players });

      log(`ãƒ«ãƒ¼ãƒ ã€Œ${roomId}ã€ã«å‚åŠ ã—ã¾ã—ãŸã€‚`);

      watchRoomPlayers(roomId);
      watchTurn(roomId);
      watchTurnControl(roomId);
      watchMyHand(roomId);

      if (players.length >= 2) {
        await dealCards(roomId);
      }
    }

    function log(msg) {
      const logElem = document.getElementById("log");
      logElem.textContent = "ãƒ­ã‚°ï¼š" + msg;
    }

    function watchRoomPlayers(roomId) {
      const playersRef = ref(database, 'rooms/' + roomId + '/players');
      onValue(playersRef, (snapshot) => {
        currentPlayers = snapshot.val() || [];
        log(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${currentPlayers.join(", ")}`);
      });
    }

    function watchTurn(roomId) {
      const turnRef = ref(database, 'rooms/' + roomId + '/turnIndex');
      onValue(turnRef, (snapshot) => {
        currentTurnIndex = snapshot.val();
        updateTurnDisplay();
      });
    }

    function updateTurnDisplay() {
      if (currentPlayers.length === 0 || currentTurnIndex === null) {
        log("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¾ãŸã¯ã‚¿ãƒ¼ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }
      const currentPlayer = currentPlayers[currentTurnIndex];
      log(`ğŸ¯ ä»Šã®ã‚¿ãƒ¼ãƒ³: ${currentPlayer}`);
    }

    function watchTurnControl(roomId) {
      const turnRef = ref(database, 'rooms/' + roomId + '/turnIndex');
      const playersRef = ref(database, 'rooms/' + roomId + '/players');

      onValue(playersRef, (snapshot) => {
        currentPlayers = snapshot.val() || [];
        updateDrawButton();
      });

      onValue(turnRef, (snapshot) => {
        currentTurnIndex = snapshot.val();
        updateDrawButton();
      });
    }

    function updateDrawButton() {
      const btn = document.getElementById("drawCardBtn");
      if (currentPlayers.length === 0 || currentTurnIndex === null) {
        btn.disabled = true;
        return;
      }
      btn.disabled = (playerName !== currentPlayers[currentTurnIndex]);
    }

    async function nextTurn() {
      const roomRef = ref(database, 'rooms/' + roomId);
      const snapshot = await get(roomRef);
      if (!snapshot.exists()) return;
      const data = snapshot.val();
      const players = data.players || [];
      let turnIndex = data.turnIndex || 0;
      turnIndex = (turnIndex + 1) % players.length;
      await update(roomRef, { turnIndex });
    }

    async function dealCards(roomId) {
      const deck = shuffleDeck(createDeck());
      const playersRef = ref(database, 'rooms/' + roomId + '/players');
      const snapshot = await get(playersRef);
      if (!snapshot.exists()) {
        alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }
      const players = snapshot.val();

      const hands = {};
      for (const player of players) {
        hands[player] = [];
      }

      const maxCardsPerPlayer = 9;
      for (let i = 0; i < maxCardsPerPlayer * players.length && deck.length > 0; i++) {
        const player = players[i % players.length];
        hands[player].push(deck.pop());
      }

      const updates = {};
      for (const player of players) {
        updates['rooms/' + roomId + '/hands/' + player] = hands[player];
      }
      await update(ref(database), updates);
      log("å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«9æšãšã¤ã‚«ãƒ¼ãƒ‰ã‚’é…ã‚Šã¾ã—ãŸï¼");
    }

    function watchMyHand(roomId) {
      const handRef = ref(database, `rooms/${roomId}/hands/${playerName}`);
      onValue(handRef, (snapshot) => {
        const hand = snapshot.val() || [];
        const handDiv = document.getElementById("myHand");
        handDiv.innerHTML = "";
        hand.forEach(card => {
          const cardElem = document.createElement("span");
          cardElem.textContent = card;
          handDiv.appendChild(cardElem);
        });
      });
    }

    async function drawCard() {
      if (currentPlayers.length === 0 || currentTurnIndex === null) return;
      const myIndex = currentTurnIndex;
      const prevIndex = (myIndex - 1 + currentPlayers.length) % currentPlayers.length;
      const targetPlayer = currentPlayers[prevIndex];

      const handRef = ref(database, `rooms/${roomId}/hands/${targetPlayer}`);
      const myHandRef = ref(database, `rooms/${roomId}/hands/${playerName}`);

      const [targetSnap, mySnap] = await Promise.all([get(handRef), get(myHandRef)]);
      const targetHand = targetSnap.val() || [];
      let myHand = mySnap.val() || [];

      if (targetHand.length === 0) {
        log(`${targetPlayer}ã®æ‰‹æœ­ãŒç©ºã§ã™ï¼`);
        await nextTurn();
        return;
      }

      // ã‚«ãƒ¼ãƒ‰ã‚’1æšå¼•ã
      const randIndex = Math.floor(Math.random() * targetHand.length);
      const drawnCard = targetHand[randIndex];
      targetHand.splice(randIndex, 1);
      myHand.push(drawnCard);

      // ğŸ”¥ãƒšã‚¢ã‚’å‰Šé™¤
      const { newHand, removedPairs } = removePairs(myHand);

      // Firebase ã«åæ˜ 
      await update(ref(database), {
        [`rooms/${roomId}/hands/${targetPlayer}`]: targetHand,
        [`rooms/${roomId}/hands/${playerName}`]: newHand
      });

      // ãƒ­ã‚°è¡¨ç¤º
      if (removedPairs.length > 0) {
        log(`${targetPlayer}ã‹ã‚‰ã€Œ${drawnCard}ã€ã‚’å¼•ã„ãŸï¼ âœ ãƒšã‚¢ã‚’å‰Šé™¤: ${removedPairs.join(", ")}`);
      } else {
        log(`${targetPlayer}ã‹ã‚‰ã€Œ${drawnCard}ã€ã‚’å¼•ã„ãŸï¼ ãƒšã‚¢ã¯ãªã—`);
      }

      await nextTurn();
    }


    function removePairs(hand) {
      const countMap = {};
      for (const card of hand) {
        const rank = card.startsWith("JOKER") ? "JOKER" : card.slice(0, -1);
        if (!countMap[rank]) countMap[rank] = [];
        countMap[rank].push(card);
      }

      const newHand = [];
      const removedPairs = [];

      for (const rank in countMap) {
        const cards = countMap[rank];
        if (rank === "JOKER") {
          newHand.push(...cards); // ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼ã¯ãƒšã‚¢å¯¾è±¡å¤–
        } else {
          const pairCount = Math.floor(cards.length / 2) * 2;
          removedPairs.push(...cards.slice(0, pairCount));
          newHand.push(...cards.slice(pairCount));
        }
      }

      return { newHand, removedPairs };
    }



    window.createRoom = createRoom;
    window.joinRoom = joinRoom;
    window.drawCard = drawCard;

  </script>
</body>

</html>
