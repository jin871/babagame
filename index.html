<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒãƒæŠœãã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆç°¡æ˜“ç‰ˆï¼‰</title>
<style>
  #myHand span {
    display: inline-block;
    border: 1px solid #333;
    border-radius: 6px;
    padding: 8px 12px;
    margin: 2px;
    font-size: 20px;
    cursor: default;
    user-select: none;
  }
  #log {
    margin-top: 10px;
    font-weight: bold;
  }
</style>
</head>
<body>

<h2>ãƒãƒæŠœãã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆç°¡æ˜“ç‰ˆï¼‰</h2>

<p>
  ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å: <input id="playerName" type="text" placeholder="åå‰ã‚’å…¥åŠ›" />
</p>
<p>
  ãƒ«ãƒ¼ãƒ ID: <input id="roomId" type="text" placeholder="ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›" />
</p>
<p>
  <button onclick="createRoom()">ãƒ«ãƒ¼ãƒ ä½œæˆ</button>
  <button onclick="joinRoom()">ãƒ«ãƒ¼ãƒ å‚åŠ </button>
</p>

<p id="log">ãƒ­ã‚°ï¼šã“ã“ã«è¡¨ç¤º</p>

<button id="drawCardBtn" disabled onclick="drawCard()">ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã</button>

<h3>è‡ªåˆ†ã®æ‰‹æœ­</h3>
<div id="myHand"></div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

  // Firebase åˆæœŸåŒ–è¨­å®šï¼ˆã‚ãªãŸã®ç’°å¢ƒã«åˆã‚ã›ã¦æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼‰
  const firebaseConfig = {
    apiKey: "AIzaSyA0D7fOnIvQFU3O29q6bb_6gj5tWN23N0s",
    authDomain: "memory-game-10e98.firebaseapp.com",
    databaseURL: "https://memory-game-10e98-default-rtdb.firebaseio.com",
    projectId: "memory-game-10e98",
    storageBucket: "memory-game-10e98.firebasestorage.app",
    messagingSenderId: "435852264433",
    appId: "1:435852264433:web:0ef957830b634b9eb13a50",
    measurementId: "G-8GN7P9PFX7"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  let playerName = "";
  let roomId = "";
  let currentPlayers = [];
  let currentTurnIndex = null;

  // ãƒ‡ãƒƒã‚­ç”Ÿæˆ
  function createDeck() {
    const suits = ["â™ ", "â™¥", "â™¦", "â™£"];
    const ranks = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];
    const deck = [];

    for (const suit of suits) {
      for (const rank of ranks) {
        deck.push(rank + suit);
      }
    }
    deck.push("JOKER"); // ã‚¸ãƒ§ãƒ¼ã‚«ãƒ¼1æš
    return deck;
  }

  // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  function shuffleDeck(deck) {
    for (let i = deck.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [deck[i], deck[j]] = [deck[j], deck[i]];
    }
    return deck;
  }

  // ãƒ«ãƒ¼ãƒ ä½œæˆ
  async function createRoom() {
    playerName = document.getElementById("playerName").value.trim();
    roomId = document.getElementById("roomId").value.trim();
    if (!playerName || !roomId) {
      alert("åå‰ã¨ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    const roomRef = ref(database, 'rooms/' + roomId);
    const snapshot = await get(roomRef);
    if (snapshot.exists()) {
      alert("ãã®ãƒ«ãƒ¼ãƒ IDã¯æ—¢ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™");
      return;
    }

    await set(roomRef, {
      players: [playerName],
      turnIndex: 0,
      state: "waiting"
    });

    log(`ãƒ«ãƒ¼ãƒ ã€Œ${roomId}ã€ã‚’ä½œæˆã—ã¾ã—ãŸã€‚å‚åŠ å¾…ã¡...`);
    watchRoomPlayers(roomId);
    watchTurn(roomId);
    watchTurnControl(roomId);
    watchMyHand(roomId);
  }

  // ãƒ«ãƒ¼ãƒ å‚åŠ 
  async function joinRoom() {
    playerName = document.getElementById("playerName").value.trim();
    roomId = document.getElementById("roomId").value.trim();
    if (!playerName || !roomId) {
      alert("åå‰ã¨ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    const roomRef = ref(database, 'rooms/' + roomId);
    const snapshot = await get(roomRef);
    if (!snapshot.exists()) {
      alert("ãƒ«ãƒ¼ãƒ ãŒå­˜åœ¨ã—ã¾ã›ã‚“");
      return;
    }
    const data = snapshot.val();
    const players = data.players || [];

    if (players.length >= 4) {
      alert("ã“ã®ãƒ«ãƒ¼ãƒ ã¯æº€å“¡ã§ã™");
      return;
    }

    if (players.includes(playerName)) {
      alert("ãã®åå‰ã¯ã™ã§ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™");
      return;
    }

    players.push(playerName);
    await update(roomRef, { players });

    log(`ãƒ«ãƒ¼ãƒ ã€Œ${roomId}ã€ã«å‚åŠ ã—ã¾ã—ãŸã€‚`);
    watchRoomPlayers(roomId);
    watchTurn(roomId);
    watchTurnControl(roomId);
    watchMyHand(roomId);
  }

  // ãƒ­ã‚°è¡¨ç¤º
  function log(msg) {
    const logElem = document.getElementById("log");
    logElem.textContent = "ãƒ­ã‚°ï¼š" + msg;
  }

  // ãƒ«ãƒ¼ãƒ ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç›£è¦–
  function watchRoomPlayers(roomId) {
    const playersRef = ref(database, 'rooms/' + roomId + '/players');
    onValue(playersRef, (snapshot) => {
      currentPlayers = snapshot.val() || [];
      log(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${currentPlayers.join(", ")}`);
    });
  }

  // ã‚¿ãƒ¼ãƒ³ç›£è¦–ã¨è¡¨ç¤º
  function watchTurn(roomId) {
    const turnRef = ref(database, 'rooms/' + roomId + '/turnIndex');
    onValue(turnRef, (snapshot) => {
      currentTurnIndex = snapshot.val();
      updateTurnDisplay();
    });
  }

  // ã‚¿ãƒ¼ãƒ³è¡¨ç¤ºæ›´æ–°
  function updateTurnDisplay() {
    if (currentPlayers.length === 0 || currentTurnIndex === null) {
      log("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¾ãŸã¯ã‚¿ãƒ¼ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }
    const currentPlayer = currentPlayers[currentTurnIndex];
    log(`ğŸ¯ ä»Šã®ã‚¿ãƒ¼ãƒ³: ${currentPlayer}`);
  }

  // ã‚¿ãƒ¼ãƒ³åˆ¶å¾¡ã¨ã‚«ãƒ¼ãƒ‰å¼•ããƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–ç®¡ç†
  function watchTurnControl(roomId) {
    const turnRef = ref(database, 'rooms/' + roomId + '/turnIndex');
    const playersRef = ref(database, 'rooms/' + roomId + '/players');

    onValue(playersRef, (snapshot) => {
      currentPlayers = snapshot.val() || [];
      updateDrawButton();
    });

    onValue(turnRef, (snapshot) => {
      currentTurnIndex = snapshot.val();
      updateDrawButton();
    });
  }

  // ã€Œã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã€ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹ãƒ»ç„¡åŠ¹åˆ‡æ›¿
  function updateDrawButton() {
    const btn = document.getElementById("drawCardBtn");
    if (currentPlayers.length === 0 || currentTurnIndex === null) {
      btn.disabled = true;
      return;
    }
    btn.disabled = (playerName !== currentPlayers[currentTurnIndex]);
  }

  // æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸ï¼ˆã‚«ãƒ¼ãƒ‰ã‚’å¼•ã„ãŸå¾Œã«å‘¼ã¶ï¼‰
  async function nextTurn() {
    const roomRef = ref(database, 'rooms/' + roomId);
    const snapshot = await get(roomRef);
    if (!snapshot.exists()) return;
    const data = snapshot.val();
    const players = data.players || [];
    let turnIndex = data.turnIndex || 0;
    turnIndex = (turnIndex + 1) % players.length;
    await update(roomRef, { turnIndex });
  }

  // ã‚«ãƒ¼ãƒ‰é…å¸ƒï¼ˆã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦å‡ç­‰ã«é…ã‚‹ï¼‰
  async function dealCards(roomId) {
    const deck = shuffleDeck(createDeck());
    const playersRef = ref(database, 'rooms/' + roomId + '/players');
    const snapshot = await get(playersRef);
    if (!snapshot.exists()) {
      alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }
    const players = snapshot.val();

    // æ‰‹æœ­æº–å‚™
    const hands = {};
    for (const player of players) {
      hands[player] = [];
    }

    // ã‚«ãƒ¼ãƒ‰é…å¸ƒ
    let i = 0;
    while (deck.length > 0) {
      const player = players[i % players.length];
      hands[player].push(deck.pop());
      i++;
    }

    // Firebaseã«ä¿å­˜
    const updates = {};
    for (const player of players) {
      updates['rooms/' + roomId + '/hands/' + player] = hands[player];
    }
    await update(ref(database), updates);
    log("ã‚«ãƒ¼ãƒ‰ã‚’é…ã‚Šã¾ã—ãŸï¼");
  }

  // è‡ªåˆ†ã®æ‰‹æœ­ç›£è¦–ãƒ»è¡¨ç¤º
  function watchMyHand(roomId) {
    const handRef = ref(database, `rooms/${roomId}/hands/${playerName}`);
    onValue(handRef, (snapshot) => {
      const hand = snapshot.val() || [];
      const handDiv = document.getElementById("myHand");
      handDiv.innerHTML = "";
      hand.forEach(card => {
        const cardElem = document.createElement("span");
        cardElem.textContent = card;
        handDiv.appendChild(cardElem);
      });
    });
  }

  // ã€Œã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚
  async function drawCard() {
    alert("ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã¾ã™ï¼ï¼ˆå¼•ãå‡¦ç†ã¯æœªå®Ÿè£…ï¼‰");

    // æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸
    await nextTurn();
  }

  // â€» ãƒ«ãƒ¼ãƒ ä½œæˆãƒ»å‚åŠ å¾Œã«è‡ªå‹•ã§ã‚«ãƒ¼ãƒ‰é…å¸ƒã—ãŸã„å ´åˆã¯ã“ã“ã«æ›¸ãã‹ã€
  // ãƒœã‚¿ãƒ³ã‚’ç”¨æ„ã—ã¦å‘¼ã³å‡ºã—ã¦ãã ã•ã„ã€‚

  // ä¾‹: ãƒ«ãƒ¼ãƒ ä½œæˆå¾Œã™ãé…ã‚‹å ´åˆã¯ createRoom() ã®æœ€å¾Œã§
  // await dealCards(roomId);

  // ä¾‹: ãƒ«ãƒ¼ãƒ å‚åŠ å¾Œå…¨å“¡æƒã£ãŸã‚‰é…ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½œã‚‹ï¼ˆä»Šå›ã¯çœç•¥ï¼‰

</script>
</body>
</html>
